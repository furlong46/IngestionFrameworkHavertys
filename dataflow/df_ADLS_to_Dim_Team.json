{
	"name": "df_ADLS_to_Dim_Team",
	"properties": {
		"folder": {
			"name": "Dim_DataFlows/Replaced by DBX"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_sales_tbdwbld",
						"type": "DatasetReference"
					},
					"name": "Sourcetbdwbld"
				},
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_sales_tbdwwrt",
						"type": "DatasetReference"
					},
					"name": "Sourcetbdwwrt"
				},
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_HavertysDW_Dim_Team",
						"type": "DatasetReference"
					},
					"name": "SourceDimTeam"
				},
				{
					"dataset": {
						"referenceName": "ds_ADLSG2_staging_masterdata_employee_tbdwemp",
						"type": "DatasetReference"
					},
					"name": "Sourcetbdwemp"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_HavertysDW_Dim_Team",
						"type": "DatasetReference"
					},
					"name": "SinkDimTeam"
				}
			],
			"transformations": [
				{
					"name": "DistinctDesignerTeamMembers"
				},
				{
					"name": "DistinctSalesTeamMembers"
				},
				{
					"name": "DeriveOrdered1"
				},
				{
					"name": "SelectPairDownColumns1"
				},
				{
					"name": "SelectPairDownColumns2"
				},
				{
					"name": "DeriveOrdered2"
				},
				{
					"name": "UnionSalesandDesigner"
				},
				{
					"name": "SelecttbdwwrtPairColumns"
				},
				{
					"name": "UnionWithWritten1"
				},
				{
					"name": "UnionWithWritten2"
				},
				{
					"name": "DeriveHashKeyMetadata"
				},
				{
					"name": "LookupDimTeam"
				},
				{
					"name": "SelectDimTeam"
				},
				{
					"name": "FilterNoUpdateRows"
				},
				{
					"name": "AlterRow1"
				},
				{
					"name": "DeriveLookUpColumns"
				},
				{
					"name": "LookupSalesEmpNum"
				},
				{
					"name": "SelectSalesEmpNum"
				},
				{
					"name": "LookupCoSalesEmpNum"
				},
				{
					"name": "SelectCoSalesEmpNum"
				},
				{
					"name": "DeriveCoalesceColumns"
				},
				{
					"name": "SelectEmployeeLookupColumns"
				},
				{
					"name": "DeriveEmployeeLookupColumns"
				},
				{
					"name": "LookupTeamMemberName1"
				},
				{
					"name": "SelectTeamMemberName1"
				},
				{
					"name": "LookupTeamMemberName2"
				},
				{
					"name": "SelectTeamMemberName2"
				},
				{
					"name": "LookupSalesTeamMemberName1"
				},
				{
					"name": "SelectSalesTeamMemberName1"
				},
				{
					"name": "LookupSalesTeamMemberName2"
				},
				{
					"name": "SelectSalesTeamMemberName2"
				},
				{
					"name": "DeriveStringReplacement"
				},
				{
					"name": "DeriveIsNull1"
				},
				{
					"name": "DeriveIsNull2"
				},
				{
					"name": "WindowRemoveDuplicates"
				},
				{
					"name": "FilterRemoveDuplicates"
				}
			],
			"script": "\nparameters{\n\tMasterProcessNumber as string ('1')\n}\nsource(output(\n\t\tPROCESS_NUMBER as decimal(38,18),\n\t\tDIVISION as decimal(38,18),\n\t\tMARKET as decimal(38,18),\n\t\tBRANCH as decimal(38,18),\n\t\tSALENUM as decimal(38,18),\n\t\tLINE as decimal(38,18),\n\t\tTYPE as string,\n\t\tTRANTYPE as string,\n\t\tTRANSEQUENCE as decimal(38,18),\n\t\tORGSALENUM as decimal(38,18),\n\t\tBILLEDDATE as timestamp,\n\t\tWRITTENDATE as timestamp,\n\t\tITEM as string,\n\t\tGROUPSKU as string,\n\t\tQUANTITY as decimal(38,18),\n\t\tGROSSSLS as decimal(38,18),\n\t\tGRPSKUDSCT as decimal(38,18),\n\t\tRTLREDUCTION as decimal(38,18),\n\t\tOVRDISCOUNT as decimal(38,18),\n\t\tPROMODISCOUNT as decimal(38,18),\n\t\tUNCLASSDSCT as decimal(38,18),\n\t\tUNDLVALLOW as decimal(38,18),\n\t\tRETAIL as decimal(38,18),\n\t\tTAXAMT1 as decimal(38,18),\n\t\tTAXAMT2 as decimal(38,18),\n\t\tCIDNUM as decimal(38,18),\n\t\tCIDPRFSEQ as decimal(38,18),\n\t\tSALEASC as decimal(38,18),\n\t\tSALEEMPID as decimal(38,18),\n\t\tCOSALEASC as decimal(38,18),\n\t\tCOSALEEMPID as decimal(38,18),\n\t\tDESIGNER as decimal(38,18),\n\t\tCODESIGNER as decimal(38,18),\n\t\tOVRRSNID as decimal(38,18),\n\t\tOVRRSNDESC as string,\n\t\tOVRRSNCMT as string,\n\t\tOVRUSRFNAM as string,\n\t\tOVRUSRLNAM as string,\n\t\tSALEPROMO as string,\n\t\tCREDITPROMO as string,\n\t\tDELIVERYDC as decimal(38,18),\n\t\tLANDEDCOST as decimal(38,18),\n\t\tCHARGETYPE as string,\n\t\tINTERNETSALE as string,\n\t\tEXCHANGETYPE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> Sourcetbdwbld\nsource(output(\n\t\tPROCESS_NUMBER as decimal(38,18),\n\t\tDIVISION as decimal(38,18),\n\t\tMARKET as decimal(38,18),\n\t\tBRANCH as decimal(38,18),\n\t\tSALENUM as decimal(38,18),\n\t\tLINE as decimal(38,18),\n\t\tTYPE as string,\n\t\tTRANTYPE as string,\n\t\tTRANSEQUENCE as decimal(38,18),\n\t\tORGSALENUM as decimal(38,18),\n\t\tWRITTENDATE as timestamp,\n\t\tWRITTENTIME as decimal(38,18),\n\t\tITEM as string,\n\t\tGROUPSKU as string,\n\t\tQUANTITY as decimal(38,18),\n\t\tGROSSSLS as decimal(38,18),\n\t\tGRPSKUDSCT as decimal(38,18),\n\t\tRTLREDUCTION as decimal(38,18),\n\t\tOVRDISCOUNT as decimal(38,18),\n\t\tPROMODISCOUNT as decimal(38,18),\n\t\tUNCLASSDSCT as decimal(38,18),\n\t\tRETAIL as decimal(38,18),\n\t\tTAXAMT1 as decimal(38,18),\n\t\tTAXAMT2 as decimal(38,18),\n\t\tCIDNUM as decimal(38,18),\n\t\tCIDPRFSEQ as decimal(38,18),\n\t\tSALEASC as decimal(38,18),\n\t\tSALEEMPID as decimal(38,18),\n\t\tCOSALEASC as decimal(38,18),\n\t\tCOSALEEMPID as decimal(38,18),\n\t\tDESIGNER as decimal(38,18),\n\t\tCODESIGNER as decimal(38,18),\n\t\tOVRRSNID as decimal(38,18),\n\t\tOVRRSNDESC as string,\n\t\tOVRRSNCMT as string,\n\t\tOVRUSRFNAM as string,\n\t\tOVRUSRLNAM as string,\n\t\tSALEPROMO as string,\n\t\tCREDITPROMO as string,\n\t\tDELIVERYDC as decimal(38,18),\n\t\tCHARGETYPE as string,\n\t\tINTERNETSALE as string,\n\t\tEXCHANGETYPE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> Sourcetbdwwrt\nsource(output(\n\t\tTeam_sk as integer,\n\t\tTeamMember1_ID_nk as integer,\n\t\tTeamMember1_Name as string,\n\t\tTeamMember2_ID_nk as integer,\n\t\tTeamMember2_Name as string,\n\t\tTeamType_nk as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> SourceDimTeam\nsource(output(\n\t\tEMPLOYEE_NUMBER_TYPE as string,\n\t\tEMPLOYEE_NUMBER as string,\n\t\tFIRST_NAME as string,\n\t\tLAST_NAME as string,\n\t\tDIVISION as decimal(38,18),\n\t\tCENTER as decimal(38,18),\n\t\tBRANCH as decimal(38,18),\n\t\tSALES_NUMBER as decimal(38,18),\n\t\tWMS_NUMBER as decimal(38,18),\n\t\tDRIVER_NUMBER as decimal(38,18),\n\t\tDESIGNER_NUMBER as decimal(38,18)\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> Sourcetbdwemp\nDeriveOrdered2 aggregate(groupBy(TeamMember1 = TeamMember1,\n\t\tTeamMember2 = TeamMember2,\n\t\tTeamType = TeamType),\n\tCount = sum(1)) ~> DistinctDesignerTeamMembers\nDeriveOrdered1 aggregate(groupBy(TeamMember1 = TeamMember1,\n\t\tTeamMember2 = TeamMember2,\n\t\tTeamType = TeamType),\n\tCount = sum(1)) ~> DistinctSalesTeamMembers\nDeriveCoalesceColumns derive(TeamMember1 = greatest(SalesEmpID_Coalesce,CoSalesEmpID_Coalesce),\n\t\tTeamMember2 = least(SalesEmpID_Coalesce,CoSalesEmpID_Coalesce),\n\t\tTeamType = 'Sales') ~> DeriveOrdered1\nSourcetbdwbld select(mapColumn(\n\t\tSALEASC,\n\t\tCOSALEASC,\n\t\tDESIGNER,\n\t\tCODESIGNER,\n\t\tDIVISION,\n\t\tMARKET,\n\t\tSALEEMPID,\n\t\tCOSALEEMPID\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectPairDownColumns1\nSourcetbdwbld select(mapColumn(\n\t\tSALEASC,\n\t\tCOSALEASC,\n\t\tDESIGNER,\n\t\tCODESIGNER,\n\t\tDIVISION,\n\t\tMARKET,\n\t\tSALEEMPID,\n\t\tCOSALEEMPID\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectPairDownColumns2\nDeriveIsNull1 derive(TeamMember1 = greatest(DESIGNER,CODESIGNER),\n\t\tTeamMember2 = least(DESIGNER,CODESIGNER),\n\t\tTeamType = 'Designer') ~> DeriveOrdered2\nSelectTeamMemberName2, SelectSalesTeamMemberName2 union(byName: true)~> UnionSalesandDesigner\nSourcetbdwwrt select(mapColumn(\n\t\tSALEASC,\n\t\tCOSALEASC,\n\t\tDESIGNER,\n\t\tCODESIGNER,\n\t\tDIVISION,\n\t\tMARKET,\n\t\tSALEEMPID,\n\t\tCOSALEEMPID\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelecttbdwwrtPairColumns\nSelectPairDownColumns2, SelecttbdwwrtPairColumns union(byName: true)~> UnionWithWritten1\nSelectPairDownColumns1, SelecttbdwwrtPairColumns union(byName: true)~> UnionWithWritten2\nDeriveStringReplacement derive(HashKey = sha1(TeamMember1_Name,TeamMember2_Name),\n\t\tSourceSystem_fk = 0,\n\t\tETLBatchID_Insert = iifNull(ETLBatchID_Insert_Dim, toInteger($MasterProcessNumber)),\n\t\tETLBatchID_Update = toInteger($MasterProcessNumber)) ~> DeriveHashKeyMetadata\nUnionSalesandDesigner, SourceDimTeam lookup(UnionSalesandDesigner@TeamMember1_ID_nk == SourceDimTeam@TeamMember1_ID_nk\n\t&& UnionSalesandDesigner@TeamMember2_ID_nk == SourceDimTeam@TeamMember2_ID_nk\n\t&& UnionSalesandDesigner@TeamType_nk == SourceDimTeam@TeamType_nk,\n\tbroadcast: 'none')~> LookupDimTeam\nLookupDimTeam select(mapColumn(\n\t\tTeamMember1_ID_nk = {UnionSalesandDesigner@TeamMember1_ID_nk},\n\t\tTeamMember2_ID_nk = {UnionSalesandDesigner@TeamMember2_ID_nk},\n\t\tTeamType_nk = {UnionSalesandDesigner@TeamType_nk},\n\t\tTeamMember1_Name = {UnionSalesandDesigner@TeamMember1_Name},\n\t\tTeamMember2_Name = {UnionSalesandDesigner@TeamMember2_Name},\n\t\tTeam_sk_Dim = Team_sk,\n\t\tHashKey_Dim = HashKey,\n\t\tETLBatchID_Insert_Dim = ETLBatchID_Insert\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectDimTeam\nFilterRemoveDuplicates filter(isNull(Team_sk_Dim)||!isNull(Team_sk_Dim)&&HashKey!=HashKey_Dim) ~> FilterNoUpdateRows\nFilterNoUpdateRows alterRow(insertIf(isNull(Team_sk_Dim)),\n\tupdateIf(!isNull(Team_sk_Dim)&&HashKey!=HashKey_Dim)) ~> AlterRow1\nDeriveIsNull2 derive(SALEASC_LookUp = DIVISION * 1000000 + MARKET * 1000 + SALEASC,\n\t\tCOSALEASC_LookUp = DIVISION * 1000000 + MARKET * 1000 + COSALEASC) ~> DeriveLookUpColumns\nDeriveLookUpColumns, Sourcetbdwemp lookup(SALEASC_LookUp == SALES_NUMBER,\n\tbroadcast: 'none')~> LookupSalesEmpNum\nLookupSalesEmpNum select(mapColumn(\n\t\tSALEASC,\n\t\tCOSALEASC,\n\t\tDESIGNER,\n\t\tCODESIGNER,\n\t\tDIVISION = {UnionWithWritten2@DIVISION},\n\t\tMARKET,\n\t\tSALEEMPID,\n\t\tCOSALEEMPID,\n\t\tSALEASC_LookUp,\n\t\tCOSALEASC_LookUp,\n\t\tSalesEmpID = EMPLOYEE_NUMBER\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectSalesEmpNum\nSelectSalesEmpNum, Sourcetbdwemp lookup(COSALEASC_LookUp == SALES_NUMBER,\n\tbroadcast: 'none')~> LookupCoSalesEmpNum\nLookupCoSalesEmpNum select(mapColumn(\n\t\tSALEASC,\n\t\tCOSALEASC,\n\t\tDESIGNER,\n\t\tCODESIGNER,\n\t\tDIVISION = {SelectSalesEmpNum@DIVISION},\n\t\tMARKET,\n\t\tSALEEMPID,\n\t\tCOSALEEMPID,\n\t\tSALEASC_LookUp,\n\t\tCOSALEASC_LookUp,\n\t\tSalesEmpID,\n\t\tCoSalesEmpID = EMPLOYEE_NUMBER\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectCoSalesEmpNum\nSelectCoSalesEmpNum derive(SalesEmpID_Coalesce = coalesce(toInteger(SALEEMPID), toInteger(trim(SalesEmpID)), 0),\n\t\tCoSalesEmpID_Coalesce = coalesce(toInteger(COSALEEMPID), toInteger(trim(CoSalesEmpID)), 0)) ~> DeriveCoalesceColumns\nSourcetbdwemp select(mapColumn(\n\t\tEMPLOYEE_NUMBER,\n\t\tFIRST_NAME,\n\t\tLAST_NAME,\n\t\tDESIGNER_NUMBER\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectEmployeeLookupColumns\nSelectEmployeeLookupColumns derive(Employee_Number_Lookup = toInteger(trim(EMPLOYEE_NUMBER)),\n\t\tFull_Name = concat(trim(FIRST_NAME), ' ', trim(LAST_NAME))) ~> DeriveEmployeeLookupColumns\nDistinctDesignerTeamMembers, DeriveEmployeeLookupColumns lookup(TeamMember1 == DESIGNER_NUMBER,\n\tbroadcast: 'none')~> LookupTeamMemberName1\nLookupTeamMemberName1 select(mapColumn(\n\t\tTeamMember1,\n\t\tTeamMember2,\n\t\tTeamType,\n\t\tCount,\n\t\tTeamMember1_Name = Full_Name\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectTeamMemberName1\nSelectTeamMemberName1, DeriveEmployeeLookupColumns lookup(TeamMember2 == DESIGNER_NUMBER,\n\tbroadcast: 'none')~> LookupTeamMemberName2\nLookupTeamMemberName2 select(mapColumn(\n\t\tTeamMember1_ID_nk = TeamMember1,\n\t\tTeamMember2_ID_nk = TeamMember2,\n\t\tTeamType_nk = TeamType,\n\t\tCount,\n\t\tTeamMember1_Name,\n\t\tTeamMember2_Name = Full_Name\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectTeamMemberName2\nDistinctSalesTeamMembers, DeriveEmployeeLookupColumns lookup(TeamMember1 == Employee_Number_Lookup,\n\tbroadcast: 'none')~> LookupSalesTeamMemberName1\nLookupSalesTeamMemberName1 select(mapColumn(\n\t\tTeamMember1,\n\t\tTeamMember2,\n\t\tTeamType,\n\t\tCount,\n\t\tTeamMember1_Name = Full_Name\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectSalesTeamMemberName1\nSelectSalesTeamMemberName1, DeriveEmployeeLookupColumns lookup(TeamMember2 == Employee_Number_Lookup,\n\tbroadcast: 'none')~> LookupSalesTeamMemberName2\nLookupSalesTeamMemberName2 select(mapColumn(\n\t\tTeamMember1_ID_nk = TeamMember1,\n\t\tTeamMember2_ID_nk = TeamMember2,\n\t\tTeamType_nk = TeamType,\n\t\tCount,\n\t\tTeamMember1_Name,\n\t\tTeamMember2_Name = Full_Name\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectSalesTeamMemberName2\nSelectDimTeam derive(each(match(type=='string'), $$ = iifNull(trim($$), ''))) ~> DeriveStringReplacement\nUnionWithWritten1 derive(DESIGNER = iifNull(DESIGNER, 0),\n\t\tCODESIGNER = iifNull(CODESIGNER, 0)) ~> DeriveIsNull1\nUnionWithWritten2 derive(SALEASC = iifNull(SALEASC, 0),\n\t\tCOSALEASC = iifNull(COSALEASC, 0)) ~> DeriveIsNull2\nDeriveHashKeyMetadata window(over(TeamType_nk = TeamType_nk,\n\t\tTeamMember1_ID_nk = TeamMember1_ID_nk,\n\t\tTeamMember2_ID_nk = TeamMember2_ID_nk),\n\tasc(TeamMember1_ID_nk, true),\n\tasc(TeamMember2_ID_nk, true),\n\tasc(TeamType_nk, true),\n\tDupeCount = rowNumber()) ~> WindowRemoveDuplicates\nWindowRemoveDuplicates filter(DupeCount==1) ~> FilterRemoveDuplicates\nAlterRow1 sink(input(\n\t\tTeam_sk as integer,\n\t\tTeamMember1_ID_nk as integer,\n\t\tTeamMember1_Name as string,\n\t\tTeamMember2_ID_nk as integer,\n\t\tTeamMember2_Name as string,\n\t\tTeamType_nk as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['TeamMember1_ID_nk','TeamMember2_ID_nk','TeamType_nk'],\n\tformat: 'table',\n\tmapColumn(\n\t\tTeamMember1_ID_nk,\n\t\tTeamMember1_Name,\n\t\tTeamMember2_ID_nk,\n\t\tTeamMember2_Name,\n\t\tTeamType_nk,\n\t\tHashKey,\n\t\tSourceSystem_fk,\n\t\tETLBatchID_Insert,\n\t\tETLBatchID_Update\n\t)) ~> SinkDimTeam"
		}
	}
}