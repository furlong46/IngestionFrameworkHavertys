{
	"name": "df_ADLS_to_Dim_CommonFinish",
	"properties": {
		"folder": {
			"name": "Dim_DataFlows"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_Material",
						"type": "DatasetReference"
					},
					"name": "SourceTbatrmlu"
				},
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_Dim_CommonFinish",
						"type": "DatasetReference"
					},
					"name": "SourceDimCommonFinish"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_Dim_CommonFinish",
						"type": "DatasetReference"
					},
					"name": "SinkDimCommonFinish"
				}
			],
			"transformations": [
				{
					"name": "SelectFinishFields"
				},
				{
					"name": "DvClHashPlaceHolders"
				},
				{
					"name": "AlterRow"
				},
				{
					"name": "FilterTypeid6"
				},
				{
					"name": "LookupDimCommonFinish"
				},
				{
					"name": "SelectTbtmlu"
				},
				{
					"name": "DvCleanUp"
				},
				{
					"name": "FilterUpdates"
				},
				{
					"name": "WindowRemoveDuplicates"
				},
				{
					"name": "FilterDuplicates"
				}
			],
			"script": "parameters{\n\tMasterProcessNumber as string ('1')\n}\nsource(output(\n\t\tATRID as decimal(38,18),\n\t\tTYPEID as decimal(38,18),\n\t\tVALUE1 as string,\n\t\tVALUE2 as string,\n\t\tSEQ as decimal(38,18),\n\t\tCRTDATE as timestamp,\n\t\tUPDATED as timestamp,\n\t\tSYNCHED as timestamp,\n\t\tVALUE3 as string,\n\t\tVALUE4 as string,\n\t\tVALUE5 as string,\n\t\tVALUE6 as string,\n\t\tVALUE7 as string,\n\t\tVALUE8 as string,\n\t\tVALUE9 as string,\n\t\tVALUE10 as string,\n\t\tVALUE11 as string,\n\t\tVALUE12 as string,\n\t\tVALUE13 as string,\n\t\tVALUE14 as string,\n\t\tVALUE15 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> SourceTbatrmlu\nsource(output(\n\t\tCommon_Finish_sk as integer,\n\t\tCommon_Finish_Code_nk as integer,\n\t\tCommon_Finish_Name as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> SourceDimCommonFinish\nLookupDimCommonFinish select(mapColumn(\n\t\tCommon_Finish_Code_nk_Stage,\n\t\tCommon_Finish_Name = DvCleanUp@Common_Finish_Name,\n\t\tCommon_Finish_Code_nk_Dim = Common_Finish_Code_nk,\n\t\tHashKeyDim = HashKey,\n\t\tSourceSystem_fkDim = SourceSystem_fk,\n\t\tETLBatchID_InsertDim = ETLBatchID_Insert,\n\t\tETLBatchID_UpdateDim = ETLBatchID_Update\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectFinishFields\nSelectFinishFields derive(HashKeyStage = sha1(Common_Finish_Code_nk_Dim,Common_Finish_Name),\n\t\t{ETL.BatchID_Insert} = iifNull(ETLBatchID_InsertDim, toInteger($MasterProcessNumber)),\n\t\t{ETL.BatchID_Update} = toInteger($MasterProcessNumber),\n\t\tSource_System_fk_Stage = 0) ~> DvClHashPlaceHolders\nFilterUpdates alterRow(insertIf(isNull(Common_Finish_Code_nk_Dim)),\n\tupdateIf(!isNull(Common_Finish_Code_nk_Dim)&&HashKeyStage!=HashKeyDim)) ~> AlterRow\nSourceTbatrmlu filter(TYPEID == 6) ~> FilterTypeid6\nDvCleanUp, SourceDimCommonFinish lookup(Common_Finish_Code_nk_Stage == Common_Finish_Code_nk,\n\tmultiple: true,\n\tbroadcast: 'none')~> LookupDimCommonFinish\nFilterTypeid6 select(mapColumn(\n\t\tCommon_Finish_Code_nk_Stage = ATRID,\n\t\tCommon_Finish_Name = VALUE1\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectTbtmlu\nSelectTbtmlu derive(each(match(type=='string'), $$ = iifNull(trim($$),''))) ~> DvCleanUp\nFilterDuplicates filter(isNull(Common_Finish_Code_nk_Dim)|| (!isNull(Common_Finish_Code_nk_Dim)&&HashKeyStage!=HashKeyDim)) ~> FilterUpdates\nDvClHashPlaceHolders window(over(Common_Finish_Code_nk_Stage),\n\tasc(Common_Finish_Code_nk_Stage, true),\n\tRowCount = rowNumber()) ~> WindowRemoveDuplicates\nWindowRemoveDuplicates filter(RowCount==1) ~> FilterDuplicates\nAlterRow sink(input(\n\t\tCommon_Finish_sk as integer,\n\t\tCommon_Finish_Code_nk as integer,\n\t\tCommon_Finish_Name as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['Common_Finish_Code_nk'],\n\tformat: 'table',\n\tmapColumn(\n\t\tCommon_Finish_Code_nk = Common_Finish_Code_nk_Stage,\n\t\tCommon_Finish_Name,\n\t\tHashKey = HashKeyStage,\n\t\tSourceSystem_fk = Source_System_fk_Stage,\n\t\tETLBatchID_Insert = {ETL.BatchID_Insert},\n\t\tETLBatchID_Update = {ETL.BatchID_Update}\n\t)) ~> SinkDimCommonFinish"
		}
	}
}