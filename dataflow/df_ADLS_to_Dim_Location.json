{
	"name": "df_ADLS_to_Dim_Location",
	"properties": {
		"folder": {
			"name": "Dim_DataFlows"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_masterdata_location_tbdwloc",
						"type": "DatasetReference"
					},
					"name": "SourceLocationTbdwloc"
				},
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_DW_DimLocation",
						"type": "DatasetReference"
					},
					"name": "SourceDimLocation"
				},
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_DW_DimLocation",
						"type": "DatasetReference"
					},
					"name": "SourceMarketZipLocation"
				},
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_masterdata_location_havertydirectory",
						"type": "DatasetReference"
					},
					"name": "SourceHavertyDirectory"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_DW_DimLocation",
						"type": "DatasetReference"
					},
					"name": "SinkDimLocation"
				}
			],
			"transformations": [
				{
					"name": "SelectLocationTbdwloc"
				},
				{
					"name": "DvClLocationPlaceHolders"
				},
				{
					"name": "DvClToIntegersNulls",
					"description": "Autogenerated by data preview actions"
				},
				{
					"name": "AlterRow"
				},
				{
					"name": "LookupLocationDim"
				},
				{
					"name": "SelectDimLookUp"
				},
				{
					"name": "DeriveETLBatchHashKey"
				},
				{
					"name": "FilterUpdates"
				},
				{
					"name": "DeriveTrimStrings"
				},
				{
					"name": "WindowRemoveDuplicates"
				},
				{
					"name": "FilterRemoveDuplicates"
				},
				{
					"name": "Lookup1"
				},
				{
					"name": "FilterInvalidRows"
				},
				{
					"name": "DvCCleanUpDirectory"
				},
				{
					"name": "LookupDirectory"
				},
				{
					"name": "DeriveManagerFromDirectory"
				},
				{
					"name": "SelectRemoveDirectoryColumns"
				}
			],
			"script": "parameters{\n\tMasterProcessNumber as string ('1')\n}\nsource(output(\n\t\tPROCESS_NUMBER as decimal(38,18),\n\t\tDIVISION as decimal(38,18),\n\t\tREGIONID as string,\n\t\tREGIONNAME as string,\n\t\tCENTER as decimal(38,18),\n\t\tCENTERNAME as string,\n\t\tBRANCHID as decimal(38,18),\n\t\tBRANCHNAME as string,\n\t\tLABEL as string,\n\t\tBRANCHTYPE as string,\n\t\tPHONE as decimal(38,18),\n\t\tADDRESS1 as string,\n\t\tADDRESS2 as string,\n\t\tCITY as string,\n\t\tSTATE as string,\n\t\tZIPCODE as decimal(38,18),\n\t\tLONGITUDE as decimal(38,18),\n\t\tLATITUDE as decimal(38,18),\n\t\tOPENDATE as timestamp,\n\t\tCLOSEDATE as timestamp,\n\t\tSALESSQFT as decimal(38,18),\n\t\tCONDCCSQFT as decimal(38,18),\n\t\tOFCUTLSQFT as decimal(38,18),\n\t\tWHSESQFT as decimal(38,18),\n\t\tTOTRTLSQFT as decimal(38,18),\n\t\tGROSSSQFT as decimal(38,18),\n\t\tLOCTYPE as string,\n\t\tBRANCHSIZE as string,\n\t\tTIMEZONE as string,\n\t\tMARKETMGR as string,\n\t\tBRANCHMGR as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tformat: 'parquet') ~> SourceLocationTbdwloc\nsource(output(\n\t\tLocation_sk as integer,\n\t\tLocation_Code_nk as string,\n\t\tETLBatchID_Insert as integer,\n\t\tHashKey as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT\\nLocation_sk,\\nLocation_Code_nk,\\nETLBatchID_Insert,\\nHashKey\\nFROM\\n[DW].[Dim_Location]',\n\tformat: 'query') ~> SourceDimLocation\nsource(output(\n\t\tMarket_Zip as string,\n\t\tMARKET_ID as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT \\nZIP as Market_Zip,\\nMARKET_ID \\nfrom [DW].[Dim_Location] \\nwhere Admin_flag = \\'A\\'',\n\tformat: 'query') ~> SourceMarketZipLocation\nsource(output(\n\t\tBranch as string,\n\t\tManager as string,\n\t\tMarket as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tinferDriftedColumnTypes: true,\n\tformat: 'parquet') ~> SourceHavertyDirectory\nSourceLocationTbdwloc select(mapColumn(\n\t\tDivision_ID = DIVISION,\n\t\tRegion_ID = REGIONID,\n\t\tRegion = REGIONNAME,\n\t\tMarket_ID = CENTER,\n\t\tMarket = CENTERNAME,\n\t\tLocation_ID = BRANCHID,\n\t\tLocation_Name = BRANCHNAME,\n\t\tLabel = LABEL,\n\t\tBranch_Type = BRANCHTYPE,\n\t\tPhone_Number = PHONE,\n\t\tAddress_1 = ADDRESS1,\n\t\tAddress_2 = ADDRESS2,\n\t\tCity = CITY,\n\t\tState = STATE,\n\t\tZIP = ZIPCODE,\n\t\tLongitude = LONGITUDE,\n\t\tLatitude = LATITUDE,\n\t\tBranch_Announced_Date = OPENDATE,\n\t\tBranch_Shut_Down_Date = CLOSEDATE,\n\t\tSales_Square_Feet = SALESSQFT,\n\t\tSales_Conditioned_CC_Square_Feet = CONDCCSQFT,\n\t\tOffice_Utility_Square_Feet = OFCUTLSQFT,\n\t\tWarehouse_Square_Feet = WHSESQFT,\n\t\tTotal_Sales_Square_Feet = TOTRTLSQFT,\n\t\tTotal_Square_Feet = GROSSSQFT,\n\t\tAdmin_Flag = LOCTYPE,\n\t\tSize = BRANCHSIZE,\n\t\tTime_Zone = TIMEZONE,\n\t\tMarket_Manager = MARKETMGR,\n\t\tLocation_Sales_Manager = BRANCHMGR,\n\t\tLocation_Type = LOCTYPE\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectLocationTbdwloc\nDvClToIntegersNulls derive(Location_Code_nk = iif(Location_ID < 10,\r\n    iif(Market_Code < 10,\r\n    concat(toString(Division_ID), '00', toString(Market_Code),'-0', toString(Location_ID)),\r\n        concat(toString(Division_ID), '0', toString(Market_Code),'-0', toString(Location_ID))\r\n    ),\r\n        iif(Market_Code < 10,\r\n        concat(toString(Division_ID), '00', toString(Market_Code),'-', toString(Location_ID)),\r\n        concat(toString(Division_ID), '0', toString(Market_Code),'-', toString(Location_ID))\r\n        )\r\n),\n\t\tLocation_Sales_Manager = iif(isNull(Location_Sales_Manager),' ',Location_Sales_Manager),\n\t\tMarket_Manager = iif(isNull(Market_Manager),' ',Market_Manager),\n\t\tAccounting_Unit = '0',\n\t\tBranch_Open_date = toDate('01/01/1900', 'MM/dd/yyyy'),\n\t\tBranch_Close_date = toDate('01/01/1900', 'MM/dd/yyyy'),\n\t\tSourceSystem_fk = 0) ~> DvClLocationPlaceHolders\nSelectLocationTbdwloc derive(Division_ID = toInteger(Division_ID),\n\t\tMarket_ID = toInteger(iif(isNull(Market_ID), '', toString(Market_ID))),\n\t\tLocation_ID = toInteger(iif(isNull(Location_ID), '', toString(Location_ID))),\n\t\tZip = left(toString(toLong(ZIP)), 5),\n\t\tSales_Square_Feet = toInteger(iif(isNull(Sales_Square_Feet),toDecimal(0),toDecimal(Sales_Square_Feet))),\n\t\tSales_Conditioned_CC_Square_Feet = toInteger(iif(isNull(Sales_Conditioned_CC_Square_Feet),toDecimal(0),toDecimal(Sales_Conditioned_CC_Square_Feet))),\n\t\tOffice_Utility_Square_Feet = toInteger(iif(isNull(Office_Utility_Square_Feet),toDecimal(0),toDecimal(Office_Utility_Square_Feet))),\n\t\tWarehouse_Square_Feet = toInteger(iif(isNull(Warehouse_Square_Feet),toDecimal(0),toDecimal(Warehouse_Square_Feet))),\n\t\tTotal_Sales_Square_Feet = toInteger(iif(isNull(Total_Sales_Square_Feet),toDecimal(0),toDecimal(Total_Sales_Square_Feet))),\n\t\tTotal_Square_Feet = toInteger(iif(isNull(Total_Square_Feet),toDecimal(0),toDecimal(Total_Square_Feet))),\n\t\tRegion_ID = iif(isNull(Region_ID), '', Region_ID),\n\t\tRegion = iif(isNull(Region), '', Region),\n\t\tLabel = iif(isNull(Label), '', Label),\n\t\tBranch_Announced_Date = iif(isNull(Branch_Announced_Date),toTimestamp(01/01/1900, 'mm/dd/yyyy'),Branch_Announced_Date),\n\t\tBranch_Shut_Down_Date = iif(isNull(Branch_Shut_Down_Date),toTimestamp(01/01/1900, 'mm/dd/yyyy'),Branch_Shut_Down_Date),\n\t\tAdmin_Flag = iif(isNull(Admin_Flag), '', Admin_Flag),\n\t\tSize = iif(isNull(Size), '', Size),\n\t\tCountry = iif(isNull(State),'','USA'),\n\t\tActive = iif(currentUTC()> Branch_Announced_Date && currentUTC()< Branch_Shut_Down_Date, 'Y', 'N'),\n\t\tMarket_Code = toInteger(concat('0'+ toString(Market_ID))),\n\t\tDivision = iif(Division_ID == 1, 'Store', 'Distribution Center'),\n\t\tZip4 = right(toString(toLong(ZIP)), 4)) ~> DvClToIntegersNulls\nFilterUpdates alterRow(insertIf(isNull(Location_skDim)),\n\tupdateIf(!isNull(Location_skDim)&&HashKey!=HashKeyDim)) ~> AlterRow\nDeriveTrimStrings, SourceDimLocation lookup(DeriveTrimStrings@Location_Code_nk == SourceDimLocation@Location_Code_nk,\n\tmultiple: true,\n\tbroadcast: 'none')~> LookupLocationDim\nLookupLocationDim select(mapColumn(\n\t\tDivision_ID,\n\t\tRegion_ID,\n\t\tRegion,\n\t\tMarket_ID,\n\t\tMarket,\n\t\tLocation_ID,\n\t\tLocation_Name,\n\t\tLabel,\n\t\tBranch_Type,\n\t\tPhone_Number,\n\t\tAddress_1,\n\t\tAddress_2,\n\t\tCity,\n\t\tState,\n\t\tLongitude,\n\t\tLatitude,\n\t\tBranch_Announced_Date,\n\t\tBranch_Shut_Down_Date,\n\t\tSales_Square_Feet,\n\t\tSales_Conditioned_CC_Square_Feet,\n\t\tOffice_Utility_Square_Feet,\n\t\tWarehouse_Square_Feet,\n\t\tTotal_Sales_Square_Feet,\n\t\tTotal_Square_Feet,\n\t\tAdmin_Flag,\n\t\tSize,\n\t\tTime_Zone,\n\t\tMarket_Manager,\n\t\tLocation_Sales_Manager,\n\t\tLocation_Type,\n\t\tZip = DeriveTrimStrings@Zip,\n\t\tCountry,\n\t\tActive,\n\t\tMarket_Code,\n\t\tDivision,\n\t\tZip4,\n\t\tLocation_Code_nk = DeriveTrimStrings@Location_Code_nk,\n\t\tAccounting_Unit,\n\t\tBranch_Open_date,\n\t\tBranch_Close_date,\n\t\tSourceSystem_fk,\n\t\tLocation_skDim = Location_sk,\n\t\tETLBatchID_InsertDim = ETLBatchID_Insert,\n\t\tHashKeyDim = HashKey\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectDimLookUp\nSelectRemoveDirectoryColumns derive(ETLBatchID_Insert = iifNull(ETLBatchID_InsertDim, toInteger($MasterProcessNumber)),\n\t\tETLBatchID_Update = toInteger($MasterProcessNumber),\n\t\tHashKey = sha1(Division_ID,\r\nRegion_ID,\r\nRegion,\r\nMarket_ID,\r\nMarket,\r\nLocation_ID,\r\nLocation_Name,\r\nLabel,\r\nBranch_Type,\r\nLocation_Type,\r\nPhone_Number,\r\nAddress_1,\r\nAddress_2,\r\nCity,\r\nState,\r\nZip,\r\nZip4,\r\nMarket_Zip,\r\nLongitude,\r\nLatitude,\r\nBranch_Announced_Date,\r\nBranch_Shut_Down_Date,\r\nSales_Square_Feet,\r\nSales_Conditioned_CC_Square_Feet,\r\nOffice_Utility_Square_Feet,\r\nWarehouse_Square_Feet,\r\nTotal_Sales_Square_Feet,\r\nTotal_Square_Feet,\r\nAdmin_Flag,Size,\r\nTime_Zone,\r\nMarket_Manager,\r\nLocation_Sales_Manager,\r\nCountry,Active,\r\nMarket_Code,Division,\r\nAccounting_Unit,\r\nBranch_Open_date,\r\nBranch_Close_date)) ~> DeriveETLBatchHashKey\nFilterRemoveDuplicates filter(isNull(Location_skDim)||(!isNull(Location_skDim)&&HashKey!=HashKeyDim)) ~> FilterUpdates\nDvClLocationPlaceHolders derive(each(match(type=='string'), $$ = iifNull(trim($$), '')),\n\t\tLongitude = iifNull(Longitude, 0),\n\t\tLatitude = iifNull(Latitude, 0)) ~> DeriveTrimStrings\nDeriveETLBatchHashKey window(over(Location_Code_nk),\n\tasc(Location_Code_nk, true),\n\tRowCount = rowNumber()) ~> WindowRemoveDuplicates\nWindowRemoveDuplicates filter(RowCount==1) ~> FilterRemoveDuplicates\nSelectDimLookUp, SourceMarketZipLocation lookup(SelectDimLookUp@Market_ID == SourceMarketZipLocation@MARKET_ID,\n\tmultiple: true,\n\tbroadcast: 'none')~> Lookup1\nSourceHavertyDirectory filter(trim(coalesce(Market, '')) != '' && trim(coalesce(Branch, '')) != '' && trim(coalesce(Manager, '')) != '' && \r\nlength(trim(coalesce(Market, ''))) == 4 && substring(trim(coalesce(Market, '')), 1, 1) == '1') ~> FilterInvalidRows\nFilterInvalidRows derive(Location_Code_nk = concat(trim(Market), '-', right(concat('0', trim(Branch)), 2)),\n\t\tDirectoryManager = trim(Manager)) ~> DvCCleanUpDirectory\nLookup1, DvCCleanUpDirectory lookup(SelectDimLookUp@Location_Code_nk == DvCCleanUpDirectory@Location_Code_nk,\n\tmultiple: true,\n\tbroadcast: 'none')~> LookupDirectory\nLookupDirectory derive(Location_Sales_Manager = iif(equals(coalesce(DirectoryManager, ''), ''), Location_Sales_Manager, DirectoryManager)) ~> DeriveManagerFromDirectory\nDeriveManagerFromDirectory select(mapColumn(\n\t\tDivision_ID,\n\t\tRegion_ID,\n\t\tRegion,\n\t\tMarket_ID = SelectDimLookUp@Market_ID,\n\t\tMarket = SelectDimLookUp@Market,\n\t\tLocation_ID,\n\t\tLocation_Name,\n\t\tLabel,\n\t\tBranch_Type,\n\t\tPhone_Number,\n\t\tAddress_1,\n\t\tAddress_2,\n\t\tCity,\n\t\tState,\n\t\tLongitude,\n\t\tLatitude,\n\t\tBranch_Announced_Date,\n\t\tBranch_Shut_Down_Date,\n\t\tSales_Square_Feet,\n\t\tSales_Conditioned_CC_Square_Feet,\n\t\tOffice_Utility_Square_Feet,\n\t\tWarehouse_Square_Feet,\n\t\tTotal_Sales_Square_Feet,\n\t\tTotal_Square_Feet,\n\t\tAdmin_Flag,\n\t\tSize,\n\t\tTime_Zone,\n\t\tMarket_Manager,\n\t\tLocation_Sales_Manager,\n\t\tLocation_Type,\n\t\tZip,\n\t\tCountry,\n\t\tActive,\n\t\tMarket_Code,\n\t\tDivision,\n\t\tZip4,\n\t\tLocation_Code_nk = SelectDimLookUp@Location_Code_nk,\n\t\tAccounting_Unit,\n\t\tBranch_Open_date,\n\t\tBranch_Close_date,\n\t\tSourceSystem_fk,\n\t\tLocation_skDim,\n\t\tETLBatchID_InsertDim,\n\t\tHashKeyDim,\n\t\tMarket_Zip,\n\t\tLocation_Code_nk = DvCCleanUpDirectory@Location_Code_nk\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> SelectRemoveDirectoryColumns\nAlterRow sink(input(\n\t\tLocation_sk as integer,\n\t\tLocation_Code_nk as string,\n\t\tDivision_ID as integer,\n\t\tDivision as string,\n\t\tRegion_ID as string,\n\t\tRegion as string,\n\t\tMarket_Code as integer,\n\t\tMarket_ID as integer,\n\t\tMarket as string,\n\t\tLocation_ID as integer,\n\t\tLocation_Name as string,\n\t\tLocation_Sales_Manager as string,\n\t\tMarket_Manager as string,\n\t\tLabel as string,\n\t\tBranch_Type as string,\n\t\tLocation_Type as string,\n\t\tPhone_Number as decimal(10,0),\n\t\tAddress_1 as string,\n\t\tAddress_2 as string,\n\t\tCity as string,\n\t\tState as string,\n\t\tCountry as string,\n\t\tZip as string,\n\t\tZip4 as string,\n\t\tMarket_Zip as string,\n\t\tLongitude as decimal(16,13),\n\t\tLatitude as decimal(16,13),\n\t\tBranch_Announced_Date as date,\n\t\tBranch_Shut_Down_Date as date,\n\t\tActive as string,\n\t\tTotal_Square_Feet as decimal(10,4),\n\t\tTotal_Sales_Square_Feet as decimal(10,4),\n\t\tSales_Conditioned_CC_Square_Feet as decimal(10,4),\n\t\tSales_Square_Feet as decimal(10,4),\n\t\tWarehouse_Square_Feet as decimal(10,4),\n\t\tOffice_Utility_Square_Feet as decimal(10,4),\n\t\tAdmin_Flag as string,\n\t\tSize as string,\n\t\tTime_Zone as string,\n\t\tAccounting_Unit as string,\n\t\tBranch_Open_Date as date,\n\t\tBranch_Close_Date as date,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['Location_Code_nk'],\n\tformat: 'table',\n\tmapColumn(\n\t\tLocation_Code_nk,\n\t\tDivision_ID,\n\t\tDivision,\n\t\tRegion_ID,\n\t\tRegion,\n\t\tMarket_Code,\n\t\tMarket_ID,\n\t\tMarket,\n\t\tLocation_ID,\n\t\tLocation_Name,\n\t\tLocation_Sales_Manager,\n\t\tMarket_Manager,\n\t\tLabel,\n\t\tBranch_Type,\n\t\tLocation_Type,\n\t\tPhone_Number,\n\t\tAddress_1,\n\t\tAddress_2,\n\t\tCity,\n\t\tState,\n\t\tCountry,\n\t\tZip,\n\t\tZip4,\n\t\tMarket_Zip,\n\t\tLongitude,\n\t\tLatitude,\n\t\tBranch_Announced_Date,\n\t\tBranch_Shut_Down_Date,\n\t\tActive,\n\t\tTotal_Square_Feet,\n\t\tTotal_Sales_Square_Feet,\n\t\tSales_Conditioned_CC_Square_Feet,\n\t\tSales_Square_Feet,\n\t\tWarehouse_Square_Feet,\n\t\tOffice_Utility_Square_Feet,\n\t\tAdmin_Flag,\n\t\tSize,\n\t\tTime_Zone,\n\t\tAccounting_Unit,\n\t\tBranch_Open_Date = Branch_Open_date,\n\t\tBranch_Close_Date = Branch_Close_date,\n\t\tHashKey,\n\t\tSourceSystem_fk,\n\t\tETLBatchID_Insert,\n\t\tETLBatchID_Update\n\t)) ~> SinkDimLocation"
		}
	}
}