{
	"name": "ds_ADLS_to_Dim_CommonColor",
	"properties": {
		"folder": {
			"name": "Dim_DataFlows"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_Material",
						"type": "DatasetReference"
					},
					"name": "SourceTbatrmlu"
				},
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_Dim_CommonColor",
						"type": "DatasetReference"
					},
					"name": "SourceCommonColorDim"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_Dim_CommonColor",
						"type": "DatasetReference"
					},
					"name": "SinkDimCommonColor"
				}
			],
			"transformations": [
				{
					"name": "SelectColorsFields"
				},
				{
					"name": "DvClHashPlaceHolders"
				},
				{
					"name": "AlterUpsert"
				},
				{
					"name": "FilterTypeid1"
				},
				{
					"name": "LookupDimCommonColor"
				},
				{
					"name": "SelectLookUpDim"
				},
				{
					"name": "FilterUpdates"
				},
				{
					"name": "WindowRemoveDuplicates"
				},
				{
					"name": "FilterRemoveDuplicates"
				},
				{
					"name": "DeriveNullTrim"
				}
			],
			"script": "parameters{\n\tMasterProcessNumber as string ('1')\n}\nsource(output(\n\t\tATRID as decimal(38,18),\n\t\tTYPEID as decimal(38,18),\n\t\tVALUE1 as string,\n\t\tVALUE2 as string,\n\t\tSEQ as decimal(38,18),\n\t\tCRTDATE as timestamp,\n\t\tUPDATED as timestamp,\n\t\tSYNCHED as timestamp,\n\t\tVALUE3 as string,\n\t\tVALUE4 as string,\n\t\tVALUE5 as string,\n\t\tVALUE6 as string,\n\t\tVALUE7 as string,\n\t\tVALUE8 as string,\n\t\tVALUE9 as string,\n\t\tVALUE10 as string,\n\t\tVALUE11 as string,\n\t\tVALUE12 as string,\n\t\tVALUE13 as string,\n\t\tVALUE14 as string,\n\t\tVALUE15 as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> SourceTbatrmlu\nsource(output(\n\t\tCommon_Color_sk as integer,\n\t\tCommon_Color_Code_nk as integer,\n\t\tCommon_Color_Name as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> SourceCommonColorDim\nFilterTypeid1 select(mapColumn(\n\t\tCommon_Color_Code_nk = ATRID,\n\t\tCommon_Color_Name = VALUE1\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectColorsFields\nSelectLookUpDim derive(HashKeyStage = sha1(Common_Color_Code_nk_Stage,Common_Color_Name_stage),\n\t\t{ETL.BatchID_InsertStage} = iifNull(ETLBatchID_InsertDim, toInteger($MasterProcessNumber)),\n\t\t{ETL.BatchID_UpdateStage} = toInteger($MasterProcessNumber),\n\t\tSource_System_fk_Stage = 0) ~> DvClHashPlaceHolders\nFilterUpdates alterRow(updateIf(!isNull(Common_Color_Code_nk_Dim)&&HashKeyStage!=HashKeyDim),\n\tinsertIf(isNull(Common_Color_Code_nk_Dim))) ~> AlterUpsert\nSourceTbatrmlu filter(TYPEID == 1 && ATRID != 0) ~> FilterTypeid1\nDeriveNullTrim, SourceCommonColorDim lookup(SelectColorsFields@Common_Color_Code_nk == SourceCommonColorDim@Common_Color_Code_nk,\n\tmultiple: true,\n\tbroadcast: 'none')~> LookupDimCommonColor\nLookupDimCommonColor select(mapColumn(\n\t\tCommon_Color_Code_nk_Stage = SelectColorsFields@Common_Color_Code_nk,\n\t\tCommon_Color_Name_stage = DeriveNullTrim@Common_Color_Name,\n\t\tCommon_Color_Code_nk_Dim = SourceCommonColorDim@Common_Color_Code_nk,\n\t\tCommon_Color_Name_Dim = SourceCommonColorDim@Common_Color_Name,\n\t\tHashKeyDim = HashKey,\n\t\tSourceSystem_fk,\n\t\tETLBatchID_InsertDim = ETLBatchID_Insert,\n\t\tETLBatchID_UpdateDim = ETLBatchID_Update\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectLookUpDim\nFilterRemoveDuplicates filter(isNull(Common_Color_Code_nk_Dim)||(!isNull(Common_Color_Code_nk_Dim)&&HashKeyStage!=HashKeyDim)) ~> FilterUpdates\nDvClHashPlaceHolders window(over(Common_Color_Code_nk_Stage),\n\tasc(Common_Color_Code_nk_Stage, true),\n\tDupeCount = rowNumber()) ~> WindowRemoveDuplicates\nWindowRemoveDuplicates filter(DupeCount==1) ~> FilterRemoveDuplicates\nSelectColorsFields derive(each(match(type=='string'), $$ = iifNull(trim($$), ''))) ~> DeriveNullTrim\nAlterUpsert sink(input(\n\t\tCommon_Color_sk as integer,\n\t\tCommon_Color_Code_nk as integer,\n\t\tCommon_Color_Name as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['Common_Color_Code_nk'],\n\tformat: 'table',\n\tmapColumn(\n\t\tCommon_Color_Code_nk = Common_Color_Code_nk_Stage,\n\t\tCommon_Color_Name = Common_Color_Name_stage,\n\t\tHashKey = HashKeyStage,\n\t\tSourceSystem_fk,\n\t\tETLBatchID_Insert = {ETL.BatchID_InsertStage},\n\t\tETLBatchID_Update = {ETL.BatchID_UpdateStage}\n\t)) ~> SinkDimCommonColor"
		}
	}
}