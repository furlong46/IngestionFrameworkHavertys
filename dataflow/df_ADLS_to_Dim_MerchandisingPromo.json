{
	"name": "df_ADLS_to_Dim_MerchandisingPromo",
	"properties": {
		"folder": {
			"name": "Dim_DataFlows"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_masterdata_tbsp",
						"type": "DatasetReference"
					},
					"name": "SourceTbsp"
				},
				{
					"dataset": {
						"referenceName": "ds_ADLSG2parquet_staging_masterdata_tbsploc",
						"type": "DatasetReference"
					},
					"name": "SourceTbsploc"
				},
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_Dim_MerchandisingPromotion",
						"type": "DatasetReference"
					},
					"name": "SourceMerchandisePromoDim"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "ds_AzureSqlTable_Dim_MerchandisingPromotion",
						"type": "DatasetReference"
					},
					"name": "SinkDimMerchPromo"
				}
			],
			"transformations": [
				{
					"name": "SelectTbsp"
				},
				{
					"name": "AlterRowMerchPromo"
				},
				{
					"name": "DvClSegment"
				},
				{
					"name": "LookupTbspTbsploc"
				},
				{
					"name": "SelectLookUp"
				},
				{
					"name": "DrClHashPlaceHolders"
				},
				{
					"name": "DvClInternet"
				},
				{
					"name": "SelectTbsploc"
				},
				{
					"name": "FilterUpdates"
				},
				{
					"name": "LookupDim"
				},
				{
					"name": "SelectDim"
				},
				{
					"name": "AggMinMax"
				},
				{
					"name": "WindowRemoveDuplicates"
				},
				{
					"name": "FilterRemoveDuplicates"
				}
			],
			"script": "\nparameters{\n\tMasterProcessNumber as string ('1')\n}\nsource(output(\n\t\tPROKEY as decimal(38,18),\n\t\tPROCODE as string,\n\t\tDESC as string,\n\t\tPROTYPE as string,\n\t\tSECURITY as string,\n\t\tCIDUSEMAX as decimal(38,18),\n\t\tCREATED as timestamp,\n\t\tUPDATED as timestamp,\n\t\tSYNCHED as timestamp,\n\t\tINTERNDESC as string,\n\t\tSEGMENT as decimal(38,18)\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> SourceTbsp\nsource(output(\n\t\tPROKEY as decimal(38,18),\n\t\tPROSEQ as decimal(38,18),\n\t\tDIVPC as decimal(38,18),\n\t\tBEGINDATE as timestamp,\n\t\tENDDATE as timestamp,\n\t\tCREATED as timestamp,\n\t\tUPDATED as timestamp\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'parquet') ~> SourceTbsploc\nsource(output(\n\t\tMerchandising_Promotion_sk as integer,\n\t\tMerchandising_Promotion_Key_nk as integer,\n\t\tMerchandising_Promotion_Code_nk as string,\n\t\tMerchandising_Promotion_Description as string,\n\t\tType_Code as string,\n\t\tType as string,\n\t\tStart_Date as date,\n\t\tEnd_Date as date,\n\t\tSegment_Code as integer,\n\t\tSegment as string,\n\t\tAvailable_on_Internet as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table') ~> SourceMerchandisePromoDim\nSourceTbsp select(mapColumn(\n\t\tMerchandising_Promotion_Key_nk = PROKEY,\n\t\tMerchandising_Promotion_Code_nk = PROCODE,\n\t\tMerchandising_Promotion_Description = DESC,\n\t\tType_Code = PROTYPE,\n\t\tSegment_Code = SEGMENT\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectTbsp\nFilterUpdates alterRow(updateIf(!isNull(Merchandising_Promotion_Key_nk_Dim)&&HashKey!=HashKeyDim),\n\tinsertIf(isNull(Merchandising_Promotion_Key_nk_Dim))) ~> AlterRowMerchPromo\nSelectTbsp derive(Segment = case(Segment_Code == 1, 'Cash Discount', Segment_Code == 2, 'Percent Off', \r\nSegment_Code == 3, 'Preferred Customer', Segment_Code == 4, 'Tax Discount',\r\nSegment_Code == 5, 'Non-Repeatable', Segment_Code == 6, 'Free Delivery',\r\nisNull(Segment_Code), ' '),\n\t\tSegment_Code = iif(isNull(Segment_Code), 0, toInteger(Segment_Code))) ~> DvClSegment\nDvClSegment, SelectTbsploc lookup(SelectTbsp@Merchandising_Promotion_Key_nk == SelectTbsploc@Merchandising_Promotion_Key_nk,\n\tbroadcast: 'none')~> LookupTbspTbsploc\nDvClInternet select(mapColumn(\n\t\tMerchandising_Promotion_Key_nk,\n\t\tMerchandising_Promotion_Code_nk,\n\t\tMerchandising_Promotion_Description,\n\t\tType_Code,\n\t\tSegment_Code,\n\t\tSegment,\n\t\tStart_Date,\n\t\tEnd_Date,\n\t\tAvailable_on_Internet_Flag\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectLookUp\nSelectDim derive(HashKey = sha1(Merchandising_Promotion_Description,\r\n\r\nType_Code,\r\nSegment_Code,\r\nSegment,\r\n\r\nStart_Date,\r\nEnd_Date),\n\t\tSourceSystem_fk = 0,\n\t\tETLBatchID_Insert = iifNull(ETLBatchID_InsertDim, toInteger($MasterProcessNumber)),\n\t\tETLBatchID_Update = toInteger($MasterProcessNumber),\n\t\tType = 0,\n\t\tStart_Date = iif(isNull(Start_Date),toTimestamp(1/1/1900),Start_Date),\n\t\tEnd_Date = iif(isNull(End_Date),toTimestamp(1/1/1900),End_Date)) ~> DrClHashPlaceHolders\nLookupTbspTbsploc derive(Merchandising_Promotion_Key_nk = toInteger(SelectTbsp@Merchandising_Promotion_Key_nk),\n\t\tAvailable_on_Internet_Flag = iif(DIVPC==1091, 'Y', 'N'),\n\t\teach(match(type=='string'), $$ = iifNull(trim($$), ''))) ~> DvClInternet\nSourceTbsploc select(mapColumn(\n\t\tMerchandising_Promotion_Key_nk = PROKEY,\n\t\tDIVPC,\n\t\tStart_Date = BEGINDATE,\n\t\tEnd_Date = ENDDATE\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectTbsploc\nFilterRemoveDuplicates filter(isNull(Merchandising_Promotion_Key_nk_Dim)||(!isNull(Merchandising_Promotion_Key_nk_Dim)&&HashKey!=HashKeyDim)) ~> FilterUpdates\nAggMinMax, SourceMerchandisePromoDim lookup(AggMinMax@Merchandising_Promotion_Key_nk == SourceMerchandisePromoDim@Merchandising_Promotion_Key_nk\n\t&& AggMinMax@Merchandising_Promotion_Code_nk == SourceMerchandisePromoDim@Merchandising_Promotion_Code_nk,\n\tbroadcast: 'none')~> LookupDim\nLookupDim select(mapColumn(\n\t\tMerchandising_Promotion_Key_nk = {AggMinMax@Merchandising_Promotion_Key_nk},\n\t\tMerchandising_Promotion_Code_nk = {AggMinMax@Merchandising_Promotion_Code_nk},\n\t\tMerchandising_Promotion_Description = {AggMinMax@Merchandising_Promotion_Description},\n\t\tType_Code = {AggMinMax@Type_Code},\n\t\tSegment_Code = {AggMinMax@Segment_Code},\n\t\tSegment = {AggMinMax@Segment},\n\t\tStart_Date = {AggMinMax@Start_Date},\n\t\tEnd_Date = {AggMinMax@End_Date},\n\t\tAvailable_on_Internet = {AggMinMax@Available_on_Internet},\n\t\tMerchandising_Promotion_sk_Dim = Merchandising_Promotion_sk,\n\t\tMerchandising_Promotion_Key_nk_Dim = {SourceMerchandisePromoDim@Merchandising_Promotion_Key_nk},\n\t\tMerchandising_Promotion_Code_nk_Dim = {SourceMerchandisePromoDim@Merchandising_Promotion_Code_nk},\n\t\tHashKeyDim = HashKey,\n\t\tETLBatchID_InsertDim = ETLBatchID_Insert,\n\t\tETLBatchID_UpdateDim = ETLBatchID_Update\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectDim\nSelectLookUp aggregate(groupBy(Merchandising_Promotion_Key_nk = Merchandising_Promotion_Key_nk,\n\t\tMerchandising_Promotion_Code_nk = Merchandising_Promotion_Code_nk,\n\t\tMerchandising_Promotion_Description = Merchandising_Promotion_Description,\n\t\tType_Code = Type_Code,\n\t\tSegment_Code = Segment_Code,\n\t\tSegment = Segment),\n\tStart_Date = min(Start_Date),\n\t\tEnd_Date = max(End_Date),\n\t\tAvailable_on_Internet = max(Available_on_Internet_Flag)) ~> AggMinMax\nDrClHashPlaceHolders window(over(Merchandising_Promotion_Code_nk = Merchandising_Promotion_Code_nk),\n\tasc(Merchandising_Promotion_Key_nk, true),\n\tRowCount = rowNumber()) ~> WindowRemoveDuplicates\nWindowRemoveDuplicates filter(RowCount==1) ~> FilterRemoveDuplicates\nAlterRowMerchPromo sink(input(\n\t\tMerchandising_Promotion_sk as integer,\n\t\tMerchandising_Promotion_Key_nk as integer,\n\t\tMerchandising_Promotion_Code_nk as string,\n\t\tMerchandising_Promotion_Description as string,\n\t\tType_Code as string,\n\t\tType as string,\n\t\tStart_Date as date,\n\t\tEnd_Date as date,\n\t\tSegment_Code as integer,\n\t\tSegment as string,\n\t\tAvailable_on_Internet as string,\n\t\tHashKey as string,\n\t\tSourceSystem_fk as integer,\n\t\tETLBatchID_Insert as integer,\n\t\tETLBatchID_Update as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['Merchandising_Promotion_Key_nk','Merchandising_Promotion_Code_nk'],\n\tformat: 'table',\n\tmapColumn(\n\t\tMerchandising_Promotion_Key_nk,\n\t\tMerchandising_Promotion_Code_nk,\n\t\tMerchandising_Promotion_Description = Merchandising_Promotion_Code_nk,\n\t\tType_Code,\n\t\tType,\n\t\tStart_Date,\n\t\tEnd_Date,\n\t\tSegment_Code,\n\t\tSegment,\n\t\tAvailable_on_Internet,\n\t\tHashKey,\n\t\tSourceSystem_fk,\n\t\tETLBatchID_Insert,\n\t\tETLBatchID_Update\n\t)) ~> SinkDimMerchPromo"
		}
	}
}